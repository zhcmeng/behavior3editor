# Behavior3 Editor 技术栈详解

## 技术栈概览

- **Electron**: 跨平台桌面应用框架
- **React + TypeScript**: 前端 UI
- **AntD**: UI 组件库
- **G6**: 图形可视化库（用于绘制行为树）
- **Zustand**: 状态管理

---

## 技术栈在界面上的分工

### 1. **Electron** - 应用外壳和系统集成

负责界面的：
- ✅ **窗口框架**：整个应用窗口、最小化/最大化/关闭按钮
- ✅ **标题栏**：自定义标题栏（在 Windows 上隐藏原生标题栏）
- ✅ **菜单栏**：顶部的 File/Edit/View 等菜单（原生菜单）
- ✅ **托盘图标**：系统托盘中的应用图标
- ✅ **对话框**：打开文件、保存文件的系统原生对话框
- ✅ **上下文菜单**：系统级右键菜单

**代码位置：**
```
electron/main/index.ts    - 窗口创建、菜单、IPC通信
electron/preload/index.ts - 暴露 Node.js API 给渲染进程
```

**界面体现：**
- 应用窗口本身
- 文件选择对话框
- 系统通知

---

### 2. **React + TypeScript** - UI 组件和业务逻辑

负责界面的：
- ✅ **所有自定义 UI 组件**：Explorer、Editor、Inspector 等
- ✅ **组件交互逻辑**：点击、拖拽、输入处理
- ✅ **状态响应式更新**：数据变化 → UI 自动更新
- ✅ **组件生命周期管理**：挂载、更新、卸载

**代码位置：**
```
src/components/
  ├── workspace.tsx    - 主布局
  ├── explorer.tsx     - 左侧文件树
  ├── editor.tsx       - 中间编辑器
  ├── inspector.tsx    - 右侧属性面板
  ├── titlebar.tsx     - 自定义标题栏
  ├── graph.ts         - 图形编辑器（使用 G6）
  └── register-node.ts - 节点渲染器
```

**界面体现：**
```
┌─────────────────────────────────────────────┐
│  [TitleBar] - React组件                      │  ← React
├──────────┬──────────────────────┬───────────┤
│ Explorer │   Editor             │ Inspector │  ← 所有都是 React 组件
│ (React)  │   (React + G6)       │ (React)   │
│          │                      │           │
│ 文件树    │   行为树画布          │ 属性面板   │
└──────────┴──────────────────────┴───────────┘
```

---

### 3. **AntD (Ant Design)** - UI 组件库

负责界面的：
- ✅ **基础组件**：按钮、输入框、下拉框、标签页等
- ✅ **布局组件**：Layout、Flex、Space 等
- ✅ **数据展示**：Tree（文件树）、Tabs（标签页）、Tooltip
- ✅ **反馈组件**：Modal（对话框）、Message（消息提示）

**具体界面元素：**

#### **Explorer（左侧文件树）**
```tsx
// AntD 组件
<DirectoryTree>        // 目录树
<Input>                // 重命名输入框
<Dropdown>             // 右键菜单
<Button>               // 按钮
```

#### **Workspace（主布局）**
```tsx
<Layout>               // 整体布局
  <Header>             // 标题栏区域
  <Sider>              // 侧边栏
  <Content>            // 内容区
</Layout>
<Tabs>                 // 多标签页
<Tooltip>              // 文件名提示
<Tag>                  // 快捷键标签
```

#### **Inspector（属性面板）**
```tsx
<Form>                 // 表单
<Input>                // 文本输入
<InputNumber>          // 数字输入
<Select>               // 下拉选择
<Switch>               // 开关
<AutoComplete>         // 自动补全
```

#### **对话框**
```tsx
<Modal>                // 模态对话框
<Button>               // 确认/取消按钮
<Flex>                 // 弹性布局
```

**代码示例：**
```tsx
// workspace.tsx 中使用的 AntD 组件
import { Layout, Tabs, Button, Flex, Tooltip, Tag } from "antd";

<Tabs                    // ← AntD 标签页组件
  type="editable-card"
  activeKey={...}
  items={...}
/>
```

---

### 4. **G6 (AntV G6)** - 图形可视化

负责界面的：
- ✅ **行为树画布**：中间编辑器的核心可视化部分
- ✅ **节点渲染**：矩形节点、文本、图标
- ✅ **连线渲染**：节点之间的连接线
- ✅ **布局算法**：自动排列节点位置（compact-box 树形布局）
- ✅ **交互功能**：拖拽、缩放、悬停、选中

**代码位置：**
```
src/components/
  ├── graph.ts         - G6 图形编辑器封装
  └── register-node.ts - 自定义节点渲染器
```

**界面体现（中间编辑器区域）：**

```
┌─────────────────────────────────┐
│  Editor 组件 (React)             │
│  ┌─────────────────────────────┐│
│  │ G6 Canvas (SVG/Canvas)      ││  ← G6 负责这部分
│  │                             ││
│  │  ┌────────┐                 ││
│  │  │ Wait   │  ← 节点         ││
│  │  │ time:1 │                 ││
│  │  └───┬────┘                 ││
│  │      │     ← 连线           ││
│  │  ┌───▼────┐                 ││
│  │  │ Log    │                 ││
│  │  └────────┘                 ││
│  └─────────────────────────────┘│
└─────────────────────────────────┘
```

**G6 功能实现：**
```tsx
// graph.ts
import { Graph as G6Graph } from "@antv/g6";

this._graph = new G6Graph({
  container: ref.current!,           // 渲染容器
  node: {
    type: "TreeNode",                // 自定义节点类型
    style: { fill: "white", ... },  // 节点样式
  },
  edge: {
    type: "cubic-horizontal",        // 曲线连接
    style: { stroke: "#A3B1BF" },   // 连线样式
  },
  layout: {
    type: "compact-box",             // 树形布局算法
    direction: "LR",                 // 从左到右
  },
  behaviors: [
    "drag-canvas",                   // 拖拽画布
    "zoom-canvas",                   // 缩放
    "hover-activate",                // 悬停激活
  ],
});
```

---

### 5. **Zustand** - 状态管理

负责界面的：
- ✅ **数据层**：不直接负责 UI，但控制 UI 显示的数据
- ✅ **状态同步**：确保多个组件看到相同的数据
- ✅ **触发更新**：状态改变 → 相关组件自动重新渲染

**管理的状态：**
```tsx
// workspace-context.ts
export const useWorkspace = create<WorkspaceStore>((set, get) => ({
  // 状态
  workdir: "",              // 工作目录
  editors: [],              // 打开的编辑器列表
  editing: undefined,       // 当前编辑器
  fileTree: undefined,      // 文件树数据
  nodeDefs: [],             // 节点定义
  editingNode: null,        // 正在编辑的节点
  
  // 操作方法
  open: (path) => { ... },
  edit: (path) => { ... },
  close: (path) => { ... },
}));
```

**界面体现（状态驱动 UI）：**

```tsx
// 状态变化流程示例
用户点击文件
  ↓
workspace.open(path)        // 更新状态
  ↓
set({ editing: editor })    // Zustand 更新
  ↓
所有订阅组件自动重新渲染：
  - Tabs activeKey 变化    // 切换标签页
  - Explorer 高亮选中      // 文件树高亮
  - Editor 刷新 Graph      // 加载新的行为树
  - Inspector 显示属性     // 显示树的属性
```

**组件如何使用 Zustand：**
```tsx
// workspace.tsx
const workspace = useWorkspace(
  useShallow((state) => ({
    editing: state.editing,     // 订阅 editing 状态
    editors: state.editors,     // 订阅 editors 状态
    open: state.open,           // 订阅 open 方法
  }))
);

// 使用状态
<Tabs activeKey={workspace.editing?.path}>  // ← 状态驱动 UI
```

---

## 完整界面分解图

```
┌─────────────────────────────────────────────────────────┐
│ Electron 窗口                                            │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ TitleBar (React + AntD)                             │ │
│ │ [Flex] [Button] [Dropdown]                          │ │
│ ├──────────┬──────────────────────────┬───────────────┤ │
│ │ Explorer │ Editor                   │ Inspector     │ │
│ │ (React)  │ (React + G6 + AntD)      │ (React+AntD)  │ │
│ │          │                          │               │ │
│ │ AntD:    │ AntD: Tabs              │ AntD:         │ │
│ │ Directory│ ┌─────────────────────┐ │ Form          │ │
│ │ Tree     │ │ G6 Canvas           │ │ Input         │ │
│ │          │ │ ┌────┐  ┌────┐     │ │ Select        │ │
│ │ [📁 root]│ │ │Wait│─→│Log │     │ │ Switch        │ │
│ │  [📄 a]  │ │ └────┘  └────┘     │ │               │ │
│ │  [📄 b]  │ │                     │ │ [属性列表...]  │ │
│ │          │ └─────────────────────┘ │               │ │
│ │          │                          │               │ │
│ └──────────┴──────────────────────────┴───────────────┘ │
│                                                           │
│ Zustand Store (数据层，不可见)                           │
│ { editing: "a.json", editors: [...], fileTree: {...} }   │
└─────────────────────────────────────────────────────────┘
```

---

## 技术栈协作示例：点击文件打开

```
1. 用户点击 Explorer 中的文件
   └→ React 事件处理: onClick

2. 调用 Zustand 方法
   └→ workspace.open(path)

3. Zustand 更新状态
   └→ set({ editing: newEditor, editors: [...] })

4. React 组件响应（自动）
   ├→ Workspace: <Tabs activeKey={...}> 切换标签页
   ├→ Explorer: 文件高亮（AntD Tree 的 selectedKeys）
   ├→ Editor: useEffect 检测到 editing 变化
   └→ Inspector: 显示新文件的属性（AntD Form）

5. G6 重新渲染
   └→ graph.refresh() → 绘制新的行为树

6. AntD 提供 UI 反馈
   └→ Message.success("文件已打开")
```

---

## 技术栈对照表

### 按界面区域分类

| 界面区域 | 使用的技术 | 具体组件 |
|---------|-----------|----------|
| **应用窗口** | Electron | BrowserWindow, Menu |
| **标题栏** | React + AntD | TitleBar.tsx, Flex, Button, Dropdown |
| **左侧文件树** | React + AntD + Zustand | Explorer.tsx, DirectoryTree, Input, Dropdown |
| **中间编辑器** | React + G6 + AntD + Zustand | Editor.tsx, Graph.ts, Tabs, Canvas |
| **右侧属性面板** | React + AntD + Zustand | Inspector.tsx, Form, Input, Select, Switch |
| **对话框** | Electron + AntD | dialog, Modal, Button |

### 按技术功能分类

| 技术 | 负责界面部分 | 具体例子 |
|------|-------------|----------|
| **Electron** | 应用外壳、系统集成 | 窗口、标题栏、文件对话框、菜单栏 |
| **React** | 所有自定义组件 | Explorer、Editor、Inspector、Workspace |
| **TypeScript** | 类型检查（不直接影响UI） | 编译时检查、代码提示、类型安全 |
| **AntD** | 基础 UI 组件 | Tree、Tabs、Button、Input、Form、Modal |
| **G6** | 图形可视化 | 行为树画布、节点、连线、布局 |
| **Zustand** | 状态管理（数据层） | 数据存储、状态同步、触发更新 |

---

## 技术栈层次关系

```
┌─────────────────────────┐
│ Electron（外壳）         │  ← 最外层：提供桌面应用能力
│ ┌─────────────────────┐ │
│ │ React（组件框架）    │ │  ← 中间层：构建 UI 组件
│ │ ┌─────────────────┐ │ │
│ │ │ AntD（UI组件）  │ │ │  ← 内层：提供基础组件
│ │ │ G6（图形渲染）  │ │ │  ← 内层：提供图形能力
│ │ └─────────────────┘ │ │
│ └─────────────────────┘ │
└─────────────────────────┘
        ↕
   Zustand（状态管理）      ← 横向：管理数据和状态
  TypeScript（类型检查）    ← 横向：提供类型安全
```

### 层次说明

1. **Electron（最外层）**
   - 创建应用窗口
   - 提供 Node.js 能力
   - 处理系统级交互

2. **React（中间层）**
   - 组件化开发
   - 声明式 UI
   - 响应式更新

3. **AntD & G6（内层）**
   - AntD：提供通用 UI 组件
   - G6：提供专业图形渲染
   - 被 React 组件调用

4. **Zustand（横向）**
   - 全局状态管理
   - 跨组件数据共享
   - 触发组件更新

5. **TypeScript（横向）**
   - 编译时类型检查
   - 代码智能提示
   - 降低运行时错误

---

## 数据流架构

```
┌─────────────────────────────────────────────────┐
│                  Electron 进程                   │
├──────────────────────┬──────────────────────────┤
│   主进程 (Main)       │   渲染进程 (Renderer)     │
├──────────────────────┼──────────────────────────┤
│ - 窗口管理            │   React 应用              │
│ - 文件系统            │   ┌────────────────┐    │
│ - IPC 通信            │   │ Zustand Store  │    │
│ - 菜单栏              │   │ (全局状态)      │    │
│                      │   └────────┬───────┘    │
│                      │            │            │
│                      │   ┌────────▼───────┐    │
│                      │   │  React 组件树   │    │
│                      │   ├────────────────┤    │
│                      │   │ - Workspace    │    │
│                      │   │ - Explorer     │    │
│                      │   │ - Editor       │    │
│                      │   │   └→ G6 Canvas │    │
│                      │   │ - Inspector    │    │
│                      │   └────────────────┘    │
│                      │            │            │
│                      │   ┌────────▼───────┐    │
│                      │   │   AntD 组件     │    │
│                      │   │ (UI基础组件)    │    │
│                      │   └────────────────┘    │
└──────────────────────┴──────────────────────────┘
```

---

## 开发时的技术栈使用指南

### 1. 何时使用 Electron API？

**需要系统级功能时：**
```tsx
// 打开文件对话框
import { dialog } from "@electron/remote";
const files = dialog.showOpenDialogSync({ ... });

// 访问文件系统
import * as fs from "fs";
fs.readFileSync(path);

// IPC 通信
import { ipcRenderer } from "electron";
ipcRenderer.invoke("open-win", path);
```

### 2. 何时使用 React？

**创建 UI 组件时：**
```tsx
// 定义组件
export const MyComponent: FC = () => {
  const [state, setState] = useState();
  
  useEffect(() => {
    // 副作用
  }, []);
  
  return <div>...</div>;
};
```

### 3. 何时使用 AntD？

**需要标准 UI 组件时：**
```tsx
// 表单
<Form>
  <Form.Item label="名称">
    <Input />
  </Form.Item>
</Form>

// 树形控件
<Tree treeData={data} onSelect={...} />

// 对话框
<Modal visible={show} onOk={...}>
  内容
</Modal>
```

### 4. 何时使用 G6？

**需要图形可视化时：**
```tsx
// 创建图形
const graph = new G6Graph({
  container: ref.current,
  data: treeData,
  layout: { type: "compact-box" },
});

// 渲染
graph.render();
```

### 5. 何时使用 Zustand？

**需要跨组件共享状态时：**
```tsx
// 定义 store
export const useStore = create((set) => ({
  count: 0,
  increment: () => set((state) => ({ count: state.count + 1 })),
}));

// 使用 store
const { count, increment } = useStore();
```

---

## 技术选型原因

### 为什么选择 Electron？
- ✅ 跨平台（Windows、macOS、Linux）
- ✅ 可以使用 Web 技术开发桌面应用
- ✅ 可以访问文件系统和系统 API
- ✅ 自动更新支持

### 为什么选择 React？
- ✅ 组件化开发，复用性强
- ✅ 声明式 UI，代码可读性好
- ✅ 生态丰富，工具链完善
- ✅ 性能优秀（Virtual DOM）

### 为什么选择 TypeScript？
- ✅ 类型安全，减少运行时错误
- ✅ 代码提示完善，开发效率高
- ✅ 重构更安全
- ✅ 大型项目维护性好

### 为什么选择 AntD？
- ✅ 组件丰富，开箱即用
- ✅ 设计统一，美观专业
- ✅ 文档完善，社区活跃
- ✅ 企业级应用经验

### 为什么选择 G6？
- ✅ 专业的图形可视化库
- ✅ 支持树形、图形等多种布局
- ✅ 交互能力强（拖拽、缩放等）
- ✅ 性能优秀，支持大规模数据
- ✅ 同属 AntV 生态，与 AntD 配合好

### 为什么选择 Zustand？
- ✅ API 简洁，学习成本低
- ✅ 性能优秀，按需更新
- ✅ TypeScript 支持好
- ✅ 不需要 Provider 包裹
- ✅ 比 Redux 更轻量

---

## 总结

这样的技术栈组合使得 Behavior3 Editor 具备：

1. **跨平台能力**（Electron）
2. **现代化 UI**（React + AntD）
3. **类型安全**（TypeScript）
4. **专业图形渲染**（G6）
5. **简洁状态管理**（Zustand）

每个技术各司其职，协同工作，共同构建了一个功能完善、体验良好的行为树编辑器。

