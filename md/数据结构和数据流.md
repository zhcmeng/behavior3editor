# Behavior3 Editor 编辑阶段数据结构与数据流

## 概述

本文档详细说明了 Behavior3 Editor 在编辑阶段使用的所有数据结构，以及数据在系统中的流动方式。

## 目录

1. [核心数据结构](#1-核心数据结构)
2. [工作区状态结构](#2-工作区状态结构)
3. [应用设置结构](#3-应用设置结构)
4. [从 behavior3 导入的类型](#4-从-behavior3-导入的类型定义)
5. [图形编辑器数据结构](#5-图形编辑器数据结构)
6. [数据流向总结](#6-数据流向总结)

---

## 1. 核心数据结构

位置: `src/misc/b3type.ts`

这是整个编辑器的基础数据模型，定义了行为树的存储格式（JSON），也是编辑器和运行时之间的数据契约。

### 1.1 NodeData - 节点数据

行为树中单个节点的完整数据结构，是系统中最核心的数据单元。

```typescript
interface NodeData {
  // ====== 基本属性 ======
  id: string;                        // 节点唯一标识符 (如 "node_1", "node_2")
  name: string;                      // 节点类型名称 (如 "Wait", "Sequence", "Attack")
  desc?: string;                     // 节点描述 (用户自定义说明)
  
  // ====== 配置属性 ======
  args?: { [key: string]: unknown }; // 节点参数 { time: 1.5, count: 10, message: "Hello" }
  input?: string[];                  // 输入变量列表 ["target", "range", "damage"]
  output?: string[];                 // 输出变量列表 ["result", "success"]
  
  // ====== 结构属性 ======
  children?: NodeData[];             // 子节点列表 (递归结构)
  path?: string;                     // 子树路径 (引用外部子树时使用)
  
  // ====== 状态属性 ======
  debug?: boolean;                   // 调试模式 (运行时输出详细信息)
  disabled?: boolean;                // 禁用状态 (跳过执行)
  
  // ====== 运行时属性 (不保存到 JSON) ======
  mtime?: number;                    // 文件修改时间戳 (毫秒)
  size?: number[];                   // 节点尺寸 [width, height] (用于 G6 布局)
  status?: number;                   // 执行状态 (0:未执行, 1:成功, 2:失败, 3:运行中)
}
```

**用途:**
- 编辑器创建/编辑节点
- 保存到 JSON 文件
- 运行时加载并执行

**示例 JSON:**
```json
{
  "id": "node_1",
  "name": "Wait",
  "desc": "等待 1 秒",
  "args": { "time": 1.0 },
  "debug": false
}
```

### 1.2 TreeData - 行为树数据

保存到 `.json` 文件的完整行为树数据结构。

```typescript
interface TreeData {
  // ====== 元信息 ======
  version: string;                   // 格式版本号 (与编辑器版本一致)
  name: string;                      // 行为树名称 (通常与文件名一致)
  desc?: string;                     // 行为树描述
  
  // ====== 命名空间 ======
  prefix: string;                    // 变量名前缀 (避免变量冲突)
                                     // 例: prefix: "hero" → 变量 "hp" 实际为 "{hero}hp"
  
  // ====== 导出配置 ======
  export?: boolean;                  // 是否可导出为子树
                                     // true: 可被其他树导入
                                     // false: 仅供独立使用
  
  // ====== 分类与依赖 ======
  group: string[];                   // 分组标签 ["Hero", "Combat"]
  import: string[];                  // 导入的子树列表 ["sub/attack.json"]
  
  // ====== 变量声明 ======
  vars: VarDecl[];                   // 变量声明列表 (文档说明)
  
  // ====== 树结构 ======
  root: NodeData;                    // 根节点 (整棵树的入口)
}
```

**用途:**
- 定义完整的行为树
- 持久化到文件系统
- 项目管理和构建

**示例 JSON:**
```json
{
  "version": "1.8.5",
  "name": "Hero",
  "prefix": "hero",
  "desc": "英雄 AI 行为树",
  "export": false,
  "group": ["Hero", "Combat"],
  "import": ["sub/attack.json"],
  "vars": [
    { "name": "hp", "desc": "生命值" },
    { "name": "mp", "desc": "魔法值" }
  ],
  "root": {
    "id": "1",
    "name": "Sequence",
    "children": [...]
  }
}
```

### 1.3 VarDecl - 变量声明

用于文档化行为树中使用的变量，帮助策划理解和使用变量。

```typescript
interface VarDecl {
  name: string;                      // 变量名 (驼峰命名法推荐)
  desc: string;                      // 变量描述 (说明用途、类型、取值范围)
}
```

**示例:**
```json
{
  "name": "enemyCount",
  "desc": "当前敌人数量，范围: 0-100"
}
```

**注意:** 变量声明不影响运行时逻辑，只是文档说明。

### 1.4 GroupDecl - 分组声明

控制行为树的分组显示和过滤。

```typescript
interface GroupDecl {
  name: string;                      // 分组名称 ("Hero", "Monster", "NPC")
  value: boolean;                    // 是否启用 (控制文件浏览器显示)
}
```

### 1.5 ImportDecl - 导入声明

记录行为树导入的子树或变量文件信息，用于依赖管理。

```typescript
interface ImportDecl {
  path: string;                      // 导入文件的相对路径
  modified?: number;                 // 文件最后修改时间 (毫秒时间戳)
  vars: VarDecl[];                   // 从导入文件中提取的变量声明
  depends: {                         // 依赖关系 (递归依赖链)
    path: string;                    // 依赖文件路径
    modified: number;                // 依赖文件修改时间
  }[];
}
```

**用途:**
- 检测文件修改
- 变量名自动补全
- 检测循环依赖
- 依赖图可视化

**示例场景:**
```
A.json imports B.json
B.json imports C.json

A.json 的 depends: [
  { path: "B.json", modified: 1234567890 },
  { path: "C.json", modified: 1234567891 }
]
```

### 1.6 FileVarDecl - 文件变量声明汇总

汇总一个行为树文件中所有的变量声明来源。

```typescript
interface FileVarDecl {
  import: ImportDecl[];              // 导入的变量文件 (如 "vars/common.json")
  subtree: ImportDecl[];             // 导入的子树 (子树输出的变量)
  vars: VarDecl[];                   // 本文件声明的变量
}
```

**使用场景:**
- 统一的变量管理
- 变量命名检查
- 代码补全数据源

### 1.7 NodeLayout - 节点布局模式

控制节点在编辑器中的显示方式。

```typescript
type NodeLayout = "compact" | "normal";
```

- **compact**: 紧凑模式（只显示图标和名称，节省空间）
- **normal**: 正常模式（显示完整信息）

**用途:**
- 大型行为树使用紧凑模式
- 编辑时使用正常模式查看详细信息

### 1.8 NodeType - 节点类型

节点的分类类型。

```typescript
type NodeType = "Action" | "Decorator" | "Condition" | "Composite" | "Other" | "Error";
```

- **Action**: 行为节点（叶子节点，执行具体操作）
- **Decorator**: 装饰节点（单个子节点，修饰行为）
- **Condition**: 条件节点（叶子节点，判断条件）
- **Composite**: 复合节点（多个子节点，控制流程）
- **Other**: 自定义类型
- **Error**: 错误节点（节点定义未找到）

### 1.9 NodeArg - 节点参数定义

节点参数的元数据定义。

```typescript
type NodeArg = {
  name: string;                      // 参数名称
  value_type: string;                // 参数类型
  desc: string;                      // 参数描述
  
  default?: unknown;                 // 默认值
  options?: {                        // 预定义选项 (下拉选择框)
    name: string;                    // 选项显示名
    value: unknown;                  // 选项值
    desc?: string;                   // 选项描述
  }[];
};
```

**参数类型:**
- **基础类型**: `bool`, `int`, `float`, `string`, `json`, `expr`
- **可选类型**: `bool?`, `int?`, `float?`, `string?`, `json?`, `expr?`
- **数组类型**: `bool[]`, `int[]`, `float[]`, `string[]`, `json[]`, `expr[]`
- **可选数组**: `bool[]?`, `int[]?`, `float[]?`, `string[]?`, `json[]?`, `expr[]?`

**示例:**
```json
{
  "name": "operator",
  "type": "string",
  "desc": "运算符",
  "options": [
    { "name": "加法", "value": "+" },
    { "name": "减法", "value": "-" }
  ]
}
```

---

## 2. 工作区状态结构

位置: `src/contexts/workspace-context.ts`

管理整个工作区和所有打开的编辑器的全局状态。

### 2.1 EditorStore - 编辑器实例

表示一个打开的行为树文件的编辑器实例。

```typescript
class EditorStore {
  path: string;                      // 文件的完整路径
  data: TreeData;                    // 行为树数据
  declare: FileVarDecl;              // 变量声明信息
  changed: boolean;                  // 是否已修改（未保存）
  mtime: number;                     // 文件的最后修改时间（毫秒）
  alertReload: boolean;              // 是否需要提示重新加载
  focusId?: string | null;           // 当前聚焦的节点 ID
  dispatch?: (event: EditEvent, data?: unknown) => void; // 事件分发函数
}
```

**生命周期:**
1. 用户打开文件 → 创建 EditorStore
2. 编辑过程中 → 更新 changed 状态
3. 用户关闭文件 → 销毁 EditorStore

### 2.2 EditEvent - 编辑器事件类型

编辑器可以触发的所有事件。

```typescript
type EditEvent = 
  // 文件操作
  | "close"              // 关闭编辑器
  | "save"               // 保存文件
  | "reload"             // 重新加载文件
  | "rename"             // 重命名
  
  // 编辑操作
  | "copy"               // 复制节点
  | "paste"              // 粘贴节点
  | "replace"            // 替换节点
  | "delete"             // 删除节点
  | "insert"             // 插入节点
  
  // 撤销重做
  | "undo"               // 撤销操作
  | "redo"               // 重做操作
  
  // 导航操作
  | "jumpNode"           // 跳转到节点
  | "searchNode"         // 搜索节点
  
  // 刷新操作
  | "refresh"            // 刷新视图
  | "updateTree"         // 更新行为树
  | "updateNode"         // 更新节点
  
  // 其他操作
  | "editSubtree"        // 编辑子树
  | "saveAsSubtree"      // 另存为子树
  | "clickVar";          // 点击变量
```

### 2.3 FileTreeType - 文件树节点

用于在侧边栏展示文件树结构。

```typescript
type FileTreeType = {
  path: string;                      // 文件/文件夹的完整路径
  title: string;                     // 显示的标题（文件名或文件夹名）
  icon?: React.ReactNode;            // 可选的图标（React 组件）
  desc?: string;                     // 描述信息
  isLeaf?: boolean;                  // 是否为叶子节点（文件）
  children?: FileTreeType[];         // 子节点（文件夹包含的内容）
  editing?: boolean;                 // 是否正在编辑（重命名状态）
  style?: React.CSSProperties;       // 自定义样式
};
```

**特点:**
- 递归结构，支持任意深度的文件夹嵌套
- 排序规则：文件夹在前，文件在后，同级按字母顺序

### 2.4 EditNode - 正在编辑的节点

当用户在属性面板中编辑节点时使用。

```typescript
type EditNode = {
  data: NodeData;                    // 节点数据
  error?: boolean;                   // 节点是否有错误（显示红色）
  prefix: string;                    // 节点前缀（用于显示路径）
  disabled: boolean;                 // 节点是否被禁用
  subtreeEditable?: boolean;         // 子树是否可编辑
};
```

### 2.5 EditNodeDef - 正在查看的节点定义

当用户查看或编辑节点定义时使用。

```typescript
type EditNodeDef = {
  data: NodeDef;                     // 节点定义数据
  path?: string;                     // 节点定义文件路径（如果来自外部文件）
};
```

### 2.6 EditTree - 正在编辑的树属性

当用户编辑树的全局属性时使用。

```typescript
type EditTree = {
  name: string;                      // 树的名称
  desc?: string;                     // 树的描述
  export?: boolean;                  // 是否导出（在构建时包含）
  prefix?: string;                   // 树的前缀（用于命名空间）
  group: string[];                   // 启用的节点分组
  import: ImportDecl[];              // 导入的其他树
  vars: VarDecl[];                   // 树定义的变量
  subtree: ImportDecl[];             // 子树列表
  root: NodeData;                    // 根节点
};
```

### 2.7 FileMeta - 文件元数据

存储在工作区配置中的文件元信息。

```typescript
type FileMeta = {
  path: string;                      // 文件路径（相对于工作区）
  desc?: string;                     // 文件描述
  exists?: boolean;                  // 文件是否存在于磁盘
};
```

### 2.8 WorkspaceModel - 工作区配置模型

存储在 `.b3-workspace` 文件中的 JSON 结构。

```typescript
interface WorkspaceModel {
  files?: {                          // 工作区包含的所有文件
    path: string;
    desc: string;
  }[];
  settings: {
    checkExpr?: boolean;             // 是否检查表达式语法
    buildScript?: string;            // 构建脚本路径
  };
}
```

### 2.9 WorkspaceStore - 工作区状态

整个应用的核心状态管理 Store。

```typescript
type WorkspaceStore = {
  // ====== 项目操作 ======
  init: (project: string) => void;                    // 初始化工作区
  createProject: () => void;                          // 创建新项目
  openProject: (project?: string) => void;            // 打开已有项目
  batchProject: () => void;                           // 批量处理项目
  buildProject: () => void;                           // 构建项目
  
  // ====== 工作区状态 ======
  workdir: string;                                    // 工作目录
  path: string;                                       // 工作区文件路径
  settings: WorkspaceModel["settings"];               // 工作区设置
  
  // ====== 文件和编辑器管理 ======
  allFiles: Map<string, FileMeta>;                    // 所有文件的元数据
  fileTree?: FileTreeType;                            // 文件树结构
  editors: EditorStore[];                             // 所有打开的编辑器
  editing?: EditorStore;                              // 当前正在编辑的编辑器
  modifiedTime: number;                               // 文件修改时间戳
  
  // ====== 节点定义管理 ======
  nodeDefs: NodeDefs;                                 // 所有节点定义
  groupDefs: string[];                                // 所有分组定义
  usingGroups: GroupDecl[];                           // 当前启用的分组
  usingVars: Map<string, VarDecl>;                    // 当前可用的变量
  
  // ====== 编辑状态管理 ======
  editingNode?: EditNode | null;                      // 正在编辑的节点
  editingNodeDef?: EditNodeDef | null;                // 正在查看的节点定义
  editingTree?: EditTree | null;                      // 正在编辑的树属性
  
  // ====== 搜索功能 ======
  isShowingSearch: boolean;                           // 是否显示搜索面板
  
  // ====== 方法（省略详细签名） ======
  // 设置操作、文件操作、编辑器操作、保存操作、监听等
};
```

---

## 3. 应用设置结构

位置: `src/contexts/setting-context.ts`

管理应用程序的全局设置和用户偏好，持久化到用户数据目录。

### 3.1 OpenEditor - 打开的编辑器记录

记录项目中打开的文件和激活状态。

```typescript
type OpenEditor = {
  path: string;                      // 文件路径
  active: boolean;                   // 是否为当前激活的编辑器
};
```

**用途:** 恢复上次的工作会话

### 3.2 ProjectSetting - 项目设置

每个项目的独立设置。

```typescript
type ProjectSetting = {
  path: string;                      // 项目路径（.b3-workspace 文件路径）
  buildDir: string;                  // 构建输出目录
  editors: OpenEditor[];             // 打开的编辑器列表
};
```

### 3.3 SettingModel - 应用设置数据

存储在 `settings.json` 中的 JSON 结构。

```typescript
type SettingModel = {
  recent: string[];                  // 最近打开的项目列表
  layout: NodeLayout;                // 节点显示布局（紧凑/正常）
  projects: ProjectSetting[];        // 所有项目的设置
};
```

**存储位置:**
- Windows: `%APPDATA%/behavior3editor/settings.json`
- macOS: `~/Library/Application Support/behavior3editor/settings.json`
- Linux: `~/.config/behavior3editor/settings.json`

### 3.4 SettingStore - 设置状态

管理应用程序全局设置的 Zustand Store。

```typescript
type SettingStore = {
  data: SettingModel;                                 // 设置数据
  load: () => void;                                   // 从文件加载设置
  save: () => void;                                   // 保存设置到文件
  appendRecent: (path: string) => void;               // 添加到最近项目
  removeRecent: (path: string) => void;               // 从最近项目移除
  setLayout: (layout: NodeLayout) => void;            // 设置节点布局
  setBuildDir: (project: string, dir: string) => void;// 设置构建目录
  getBuildDir: (project: string) => string;           // 获取构建目录
  openEditor: (project: string, path: string) => void;// 记录打开的编辑器
  closeEditor: (project: string, path: string) => void;// 记录关闭的编辑器
  getEditors: (project: string) => OpenEditor[];      // 获取打开的编辑器
};
```

---

## 4. 从 behavior3 导入的类型定义

位置: `src/behavior3/src/behavior3/`

编辑器从运行时库导入的类型定义，仅用于编辑阶段的类型检查和元信息。

### 4.1 NodeDef - 节点定义

节点的元信息定义，描述节点的所有配置。

```typescript
interface NodeDef<GroupType extends string = string> {
  name: string;                      // 节点名称
  type: "Action" | "Decorator" | "Condition" | "Composite"; // 节点类型
  desc: string;                      // 描述
  
  // ====== 输入输出定义 ======
  input?: string[];                  // 输入定义 ["input1?", "input2..."]
  output?: string[];                 // 输出定义 ["output1", "output2..."]
  
  // ====== 参数定义 ======
  args?: NodeArg[];                  // 参数列表
  
  // ====== 文档和展示 ======
  doc?: string;                      // 文档（Markdown 格式）
  icon?: string;                     // 图标路径
  color?: string;                    // 颜色
  
  // ====== 编辑器专用 ======
  group?: GroupType[];               // 分组（用于文件树管理）
  status?: string[];                 // 状态规则（用于推导节点状态）
  children?: -1 | 0 | 1 | 2 | 3;     // 子节点数量限制
                                     // -1: 无限制, 0: 无子节点, 1-3: 固定数量
}
```

**用途:**
- 节点面板显示可用节点
- 属性面板显示参数配置
- 验证节点配置是否正确

**示例:**
```typescript
{
  name: "Wait",
  type: "Action",
  desc: "等待一段时间",
  args: [
    { name: "time", type: "float", desc: "等待时间（秒）" }
  ],
  children: 0,
  status: ["success"]
}
```

### 4.2 ObjectType - 对象类型

通用的对象类型定义。

```typescript
type ObjectType = { [k: string]: unknown };
```

**用途:**
- 表达式求值的环境变量
- 通用的键值对数据

### 4.3 Constructor - 构造函数类型

TypeScript 构造函数类型。

```typescript
type Constructor<T, A extends any[] = any[]> = new (...args: A) => T;
```

### 4.4 ExpressionEvaluator - 表达式求值器

用于验证表达式语法的类（仅使用验证功能，不执行求值）。

```typescript
class ExpressionEvaluator {
  constructor(expression: string);   // 构造函数，解析表达式
  dryRun(): boolean;                 // 验证表达式语法是否正确
  evaluate(args: ObjectType): unknown; // 求值（编辑器不使用）
}
```

**编辑器用途:**
- 验证用户输入的表达式是否合法
- 实时语法检查

**示例:**
```typescript
const expr = new ExpressionEvaluator("a + b > 10");
if (!expr.dryRun()) {
  // 显示错误提示
}
```

---

## 5. 图形编辑器数据结构

位置: `src/components/graph.ts`

基于 AntV G6 实现的可视化编辑器相关数据结构。

### 5.1 G6NodeData - G6 图形节点数据

继承自 AntV G6 库的 NodeData 类型，扩展了行为树特定的数据。

```typescript
type G6NodeData = {
  id: string;                        // 节点 ID
  data: NodeData;                    // 行为树节点数据
  style?: Record<string, any>;       // G6 样式
  // ... 其他 G6 属性
};
```

### 5.2 TreeNodeState - 节点状态样式

定义节点在不同状态下的视觉样式。

```typescript
const TreeNodeStyle = {
  selected: {                        // 选中状态
    stroke: "#5B8FF9",
    lineWidth: 3,
  },
  hover: {                           // 悬停状态
    stroke: "#91D5FF",
    lineWidth: 2,
  },
  error: {                           // 错误状态
    stroke: "#FF4D4F",
    lineWidth: 2,
  },
  disabled: {                        // 禁用状态
    fill: "#F0F0F0",
    opacity: 0.5,
  }
};
```

### 5.3 FilterOption - 搜索过滤选项

节点搜索时的过滤条件。

```typescript
type FilterOption = {
  type: "id" | "content";            // 搜索类型
  value: string;                     // 搜索值
  caseSensitive: boolean;            // 是否区分大小写
};
```

---

## 6. 数据流向总结

### 6.1 整体数据流

```
用户操作
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↓ 全局状态管理                    ↓
WorkspaceStore ←→ SettingStore
    ↓                                
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↓ 文件级状态                      ↓
EditorStore[]
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↓ 数据模型                        ↓
TreeData
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↓ 节点数据                        ↓
NodeData (递归)
    ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↓ 持久化                          ↓
JSON 文件 (.json)
    ↑
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
↑ 节点定义元信息                  ↑
NodeDef (from behavior3 库)
```

### 6.2 各层级职责

#### 6.2.1 用户界面层
- **组件**: Editor, Inspector, Explorer, Graph
- **职责**: 接收用户输入，展示数据，触发操作
- **数据**: 从 Store 读取，通过事件触发修改

#### 6.2.2 状态管理层
- **Store**: WorkspaceStore, SettingStore
- **职责**: 管理全局状态，协调多个编辑器
- **数据**: 内存中的完整状态树

#### 6.2.3 编辑器层
- **类**: EditorStore
- **职责**: 管理单个文件的编辑状态
- **数据**: TreeData + 变更状态

#### 6.2.4 数据模型层
- **类型**: TreeData, NodeData
- **职责**: 定义数据结构，提供类型约束
- **数据**: 纯数据对象

#### 6.2.5 持久化层
- **文件**: .json, .b3-workspace, settings.json
- **职责**: 数据持久化和恢复
- **数据**: JSON 序列化格式

#### 6.2.6 元信息层
- **类型**: NodeDef (from behavior3)
- **职责**: 提供节点定义和验证规则
- **数据**: 只读的元信息

### 6.3 关键数据流场景

#### 场景 1: 打开项目
```
1. 用户选择项目文件 (.b3-workspace)
2. WorkspaceStore.init(path)
3. 加载 WorkspaceModel
4. 加载 FileTree
5. 加载 NodeDefs (node-config.b3-setting)
6. 恢复上次打开的 EditorStore[]
7. 渲染界面
```

#### 场景 2: 编辑节点
```
1. 用户在 Graph 中点击节点
2. Graph 触发 onEditingNode
3. WorkspaceStore 更新 editingNode
4. Inspector 组件响应变化，显示属性面板
5. 用户修改参数
6. Inspector 触发 updateNode 事件
7. Graph 更新 NodeData
8. EditorStore.changed = true
```

#### 场景 3: 保存文件
```
1. 用户按 Ctrl+S
2. Editor 触发 save 事件
3. Graph.save() 收集所有 NodeData
4. 构建 TreeData
5. 写入 JSON 文件
6. 更新 EditorStore.mtime
7. EditorStore.changed = false
8. 更新 FileMeta
9. 保存 WorkspaceModel
```

#### 场景 4: 构建项目
```
1. 用户点击"构建项目"
2. WorkspaceStore.buildProject()
3. 保存所有打开的文件
4. 遍历 allFiles
5. 读取每个 TreeData
6. 验证节点定义 (使用 NodeDef)
7. 导出到构建目录
8. 显示构建结果
```

### 6.4 数据同步机制

#### 6.4.1 文件系统监听
```
fs.watch(workdir) → rename/change 事件
    ↓
检测文件修改
    ↓
如果是 node-config.b3-setting → 重新加载节点定义
如果是行为树文件 → 检查对应的 EditorStore
    ↓
如果 EditorStore.changed → 提示重新加载
如果未修改 → 自动重新加载
```

#### 6.4.2 跨编辑器同步
```
EditorStore A 修改了 TreeData
    ↓
触发 dispatch("updateTree")
    ↓
WorkspaceStore 更新状态
    ↓
所有依赖该树的编辑器收到通知
    ↓
重新计算变量声明 (FileVarDecl)
    ↓
更新 UI
```

### 6.5 性能优化策略

#### 6.5.1 懒加载
- 文件内容只在打开时加载
- 子树在展开时才加载
- 节点定义按需解析

#### 6.5.2 增量更新
- 只更新修改的节点
- 使用 React 的 Virtual DOM diff
- G6 的局部渲染

#### 6.5.3 防抖节流
- 文件系统事件防抖 (200ms)
- 搜索输入防抖 (300ms)
- 自动保存节流 (1000ms)

#### 6.5.4 缓存策略
- NodeDef 全局缓存
- 文件修改时间缓存 (b3util.files)
- 表达式求值器缓存

---

## 7. 关键概念说明

### 7.1 命名空间（Prefix）

**问题**: 多个行为树同时运行时，变量名可能冲突。

**解决方案**: 使用 prefix 为每棵树的变量添加命名空间。

**示例**:
```typescript
// Hero.json
{ prefix: "hero" }
// 变量 "hp" 在黑板上的完整名称: "{hero}hp"

// Monster.json
{ prefix: "monster" }
// 变量 "hp" 在黑板上的完整名称: "{monster}hp"

// 两棵树可以同时运行而不会变量冲突
```

### 7.2 子树（Subtree）

**概念**: 将行为树模块化，可复用的树片段。

**机制**:
1. 子树是独立的 `.json` 文件，设置 `export: true`
2. 父树通过 `import` 引用子树
3. 节点设置 `path` 属性指向子树文件
4. 运行时动态加载子树

**依赖管理**:
- `ImportDecl` 记录依赖关系
- 检测循环依赖
- 自动更新依赖链

### 7.3 变量声明（VarDecl）

**作用**: 文档化，不影响运行时。

**用途**:
1. 代码补全：编辑器提供变量名建议
2. 悬停提示：显示变量的描述
3. 使用统计：追踪变量的使用情况
4. 文档生成：自动生成变量列表

### 7.4 表达式（Expression）

**支持的表达式**:
- 算术运算: `a + b`, `a * 2`
- 比较运算: `a > 10`, `b == true`
- 逻辑运算: `a && b`, `!c`
- 三元运算: `a > 0 ? a : -a`
- 对象访问: `user.level`, `arr[0]`

**验证机制**:
```typescript
const expr = new ExpressionEvaluator(userInput);
if (!expr.dryRun()) {
  // 语法错误，显示提示
}
```

---

## 8. 总结

### 8.1 数据结构特点

1. **分层设计**: 从持久化到状态管理，层次清晰
2. **类型安全**: TypeScript 提供完整的类型约束
3. **可扩展**: 易于添加新的节点类型和功能
4. **向后兼容**: 版本号机制支持格式升级

### 8.2 最佳实践

1. **单一数据源**: TreeData 是数据的唯一真相来源
2. **不可变更新**: 使用 `{ ...data, changed: true }` 模式
3. **事件驱动**: 通过 dispatch 解耦组件通信
4. **状态同步**: 文件系统监听确保多窗口同步

### 8.3 扩展指南

如需添加新功能，遵循以下步骤:

1. **定义数据结构**: 在 `b3type.ts` 中添加类型定义
2. **更新 TreeData**: 如果需要持久化，扩展 TreeData 接口
3. **修改 Store**: 在 WorkspaceStore 中添加状态和方法
4. **实现 UI**: 创建对应的 React 组件
5. **处理事件**: 添加 EditEvent 和 dispatch 处理
6. **测试验证**: 确保数据流正确，文件格式兼容

---

**文档版本**: 1.0  
**最后更新**: 2025-01-14  
**适用版本**: Behavior3 Editor 1.8.5

