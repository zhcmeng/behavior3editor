# Behavior3 Editor 版本管理详解

## 📋 概述

Behavior3 Editor 使用**语义化版本号**管理编辑器和文件的版本，确保：
- 文件格式的演进和兼容性
- 团队协作时版本一致性
- 用户及时升级到最新版本

---

## 🔢 版本号的位置

### 1. 编辑器版本（两处）

#### 1.1 package.json
```json
{
  "name": "behavior3editor",
  "version": "1.8.5",  ← 应用版本（npm 标准）
  "description": "行为树编辑器"
}
```

**作用：**
- npm 包管理的版本号
- 应用安装包的版本号
- 自动更新时的版本比对

#### 1.2 src/misc/b3type.ts
```typescript
/**
 * 编辑器版本号
 * 
 * 用途：
 * - 显示在标题栏和关于界面
 * - 检测行为树文件的兼容性
 * - 自动更新版本比对
 */
export const VERSION = "1.8.5";
```

**作用：**
- 运行时使用的版本常量
- 与文件版本比对
- 创建新文件时的默认版本

### 2. 文件版本（每个 JSON 文件）

#### 行为树文件
```json
// sample/workdir/hero.json
{
  "version": "1.8.0",  ← 文件格式版本
  "name": "hero",
  "desc": "英雄测试AI",
  ...
}
```

**作用：**
- 标识此文件由哪个版本的编辑器创建
- 用于兼容性检查
- 记录文件格式版本

---

## 🔍 版本的作用

### 1. 兼容性检查

#### 1.1 版本比较函数

**代码位置：** `src/misc/b3util.ts:134-142`

```typescript
export const isNewVersion = (version: string) => {
  // 解析文件版本号：如 "1.8.5" → [1, 8, 5]
  const [major, minor, patch] = version.split(".").map(Number);
  
  // 解析编辑器版本号
  const [major2, minor2, patch2] = VERSION.split(".").map(Number);
  
  // 比较版本：文件版本 > 编辑器版本 ?
  return (
    major > major2 ||                           // 主版本更新
    (major === major2 && minor > minor2) ||     // 次版本更新
    (major === major2 && minor === minor2 && patch > patch2)  // 补丁更新
  );
};
```

**比较示例：**

| 文件版本 | 编辑器版本 | isNewVersion 结果 | 说明 |
|---------|-----------|------------------|------|
| 1.9.0 | 1.8.5 | ✅ true | 文件太新，警告 |
| 1.8.6 | 1.8.5 | ✅ true | 文件太新，警告 |
| 1.8.5 | 1.8.5 | ❌ false | 版本相同，正常 |
| 1.8.4 | 1.8.5 | ❌ false | 文件较旧，正常 |
| 1.7.0 | 1.8.5 | ❌ false | 文件较旧，正常 |

#### 1.2 打开文件时检查

**代码位置：** `src/contexts/workspace-context.ts:914-916`

```typescript
open: (path, focusId) => {
  // ... 创建 EditorStore
  
  // 版本检查
  if (b3util.isNewVersion(editor.data.version)) {
    message.warning(
      i18n.t("alertNewVersion", { version: editor.data.version })
    );
  }
}
```

**效果：**
```
打开 hero.json (version: "1.9.0")
  ↓
当前编辑器版本：1.8.5
  ↓
isNewVersion("1.9.0") → true
  ↓
显示警告弹窗：
  "此文件由新版本 Behavior3(1.9.0) 创建，请升级到最新版本。"
  ↓
文件仍然可以打开（但可能有兼容性问题）
```

**警告文本：**
```json
// public/locales/zh.json
"alertNewVersion": "此文件由新版本 Behavior3({{version}}) 创建，请升级到最新版本。"

// public/locales/en.json
"alertNewVersion": "This file is created by a newer version of Behavior3({{version}}), please upgrade to the latest version."
```

### 2. 创建文件时标记版本

#### 2.1 新建文件

**代码位置：** `src/misc/b3util.ts:918-920`

```typescript
export const createNewTree = (path: string) => {
  const tree: TreeData = {
    version: VERSION,  // ← 使用当前编辑器版本
    name: Path.basenameWithoutExt(path),
    prefix: "",
    group: [],
    import: [],
    vars: [],
    root: {
      id: "1",
      name: "Sequence",
      children: [],
    },
  };
  return tree;
}
```

**流程：**
```
用户新建文件 test.json
  ↓
调用 createNewTree("test.json")
  ↓
创建 TreeData {
  version: "1.8.5",  ← 自动使用当前编辑器版本
  name: "test",
  ...
}
  ↓
保存为 test.json
```

#### 2.2 保存文件时保留版本

```
编辑文件（修改节点、参数等）
  ↓
graph.save()
  ↓
收集 TreeData {
  version: "1.8.5",  ← 保留原有版本（不修改）
  ...
}
  ↓
写入 JSON 文件
```

**注意：**
- 编辑文件时，不会更新文件的 version 字段
- 版本号只在创建文件时设置
- 这样可以追踪文件的创建版本

---

## 🎯 语义化版本号详解

### 1. 格式

```
major.minor.patch
  │     │     │
  │     │     └─ 补丁版本（bug修复）
  │     └─────── 次版本（新功能，向前兼容）
  └─────────── 主版本（重大更新，可能不兼容）
```

### 2. 版本号递增规则

| 变更类型 | 版本递增 | 示例 |
|---------|---------|------|
| 修复 bug，无新功能 | patch + 1 | 1.8.5 → 1.8.6 |
| 添加新功能，向前兼容 | minor + 1, patch = 0 | 1.8.5 → 1.9.0 |
| 重大更新，不兼容旧版 | major + 1, minor = 0, patch = 0 | 1.8.5 → 2.0.0 |

### 3. 版本比较逻辑

#### 比较算法
```typescript
function compareVersions(v1, v2) {
  const [ma1, mi1, pa1] = v1.split(".").map(Number);
  const [ma2, mi2, pa2] = v2.split(".").map(Number);
  
  // 1. 先比较主版本
  if (ma1 !== ma2) return ma1 - ma2;
  
  // 2. 主版本相同，比较次版本
  if (mi1 !== mi2) return mi1 - mi2;
  
  // 3. 次版本也相同，比较补丁版本
  return pa1 - pa2;
}
```

#### 比较示例

```typescript
// 示例1：主版本不同
compareVersions("2.0.0", "1.8.5")
→ major: 2 vs 1 → 2 > 1 ✓
→ 2.0.0 更新

// 示例2：次版本不同
compareVersions("1.9.0", "1.8.5")
→ major: 1 vs 1 → 相等
→ minor: 9 vs 8 → 9 > 8 ✓
→ 1.9.0 更新

// 示例3：补丁版本不同
compareVersions("1.8.6", "1.8.5")
→ major: 1 vs 1 → 相等
→ minor: 8 vs 8 → 相等
→ patch: 6 vs 5 → 6 > 5 ✓
→ 1.8.6 更新

// 示例4：版本相同
compareVersions("1.8.5", "1.8.5")
→ 完全相等
→ 无需更新

// 示例5：文件较旧
compareVersions("1.7.0", "1.8.5")
→ minor: 7 vs 8 → 7 < 8
→ 文件较旧，无需警告
```

---

## 🔄 版本演进示例

### 假设的版本历史

```
v1.0.0 (2020-01)
  - 初始版本
  - 基本的行为树编辑功能
  - TreeData 格式：{ name, root }

v1.5.0 (2021-06)
  - 添加变量声明功能
  - TreeData 新增字段：vars
  - 向前兼容：旧文件仍可打开（vars 默认为空数组）

v1.8.0 (2023-03)
  - 添加子树引用功能
  - NodeData 新增字段：path
  - TreeData 新增字段：import
  - 向前兼容：旧文件仍可打开

v1.8.5 (2024-10)  ← 当前版本
  - Bug 修复和性能优化
  - 格式无变化
  - 完全兼容 1.8.x 的文件

v1.9.0 (未来)
  - 计划添加类型系统
  - VarDecl 新增字段：type
  - 向前兼容：旧文件仍可打开
```

### 兼容性矩阵

| 文件版本 | 1.7.0编辑器 | 1.8.0编辑器 | 1.8.5编辑器 | 1.9.0编辑器 |
|---------|-----------|-----------|-----------|-----------|
| **1.7.0** | ✅ 正常 | ✅ 正常 | ✅ 正常 | ✅ 正常 |
| **1.8.0** | ⚠️ 警告 | ✅ 正常 | ✅ 正常 | ✅ 正常 |
| **1.8.5** | ⚠️ 警告 | ⚠️ 警告 | ✅ 正常 | ✅ 正常 |
| **1.9.0** | ⚠️ 警告 | ⚠️ 警告 | ⚠️ 警告 | ✅ 正常 |

---

## 📝 团队协作场景

### 场景1：版本不一致导致的问题

**问题：**
```
张三（编辑器 1.8.5）创建 hero.json
  ↓
hero.json { version: "1.8.5" }
  ↓
提交到 Git
  ↓
李四（编辑器 1.7.0）打开 hero.json
  ↓
警告："此文件由新版本 1.8.5 创建"
  ↓
李四编辑并保存
  ↓
可能丢失 1.8.0+ 的新功能（如子树引用）
  ↓
数据损坏或功能异常
```

**解决方案：**
```
团队统一使用同一版本的编辑器
  ↓
所有文件版本一致
  ↓
避免兼容性问题
```

### 场景2：版本升级

**流程：**
```
项目使用 1.7.0 编辑器
  ↓
所有文件 version: "1.7.0"
  ↓
团队决定升级到 1.8.5
  ↓
1. 所有成员安装 1.8.5 编辑器
2. 打开文件，编辑器自动兼容旧版本文件
3. 编辑并保存后，version 仍为 "1.7.0"（不自动更新）
4. 如需统一版本号：
   - 手动修改 JSON 文件的 version 字段
   - 或使用批处理脚本统一更新
```

### 场景3：文件格式迁移

**当新版本改变数据格式时：**

```
// 假设 1.9.0 添加了新的必需字段

// 旧文件（1.8.0）
{
  "version": "1.8.0",
  "name": "hero",
  "root": { ... }
}

// 1.9.0 编辑器打开旧文件时
open(path) {
  const tree = readTree(path);
  
  // 检测版本
  if (tree.version < "1.9.0") {
    // 执行迁移逻辑
    tree = migrateFrom18To19(tree);
    tree.version = "1.9.0";
  }
  
  return tree;
}

// 迁移函数
function migrateFrom18To19(tree) {
  // 添加新字段的默认值
  tree.newField = defaultValue;
  return tree;
}
```

---

## 🔧 版本管理操作

### 1. 更新编辑器版本

#### 1.1 使用 npm version 命令

```bash
# 补丁版本更新（bug修复）
npm version patch
# 1.8.5 → 1.8.6

# 次版本更新（新功能）
npm version minor
# 1.8.5 → 1.9.0

# 主版本更新（重大更新）
npm version major
# 1.8.5 → 2.0.0
```

**效果：**
- 自动更新 `package.json` 的 version
- 自动创建 git commit 和 tag

#### 1.2 手动同步 VERSION 常量

```typescript
// 1. 修改 package.json
{
  "version": "1.8.6"  // 1.8.5 → 1.8.6
}

// 2. 同步修改 src/misc/b3type.ts
export const VERSION = "1.8.6";  // 1.8.5 → 1.8.6
```

**注意：**
- npm version 命令不会自动更新 VERSION 常量
- 需要手动保持两处一致
- 否则版本检查会出错

### 2. 批量更新文件版本

**场景：** 升级编辑器后，想统一所有文件的版本号

#### 方法1：使用批处理脚本

```javascript
// scripts/update-version.js
const fs = require('fs');
const glob = require('glob');

const NEW_VERSION = "1.8.5";

// 查找所有行为树文件
glob("workdir/**/*.json", (err, files) => {
  files.forEach(file => {
    const tree = JSON.parse(fs.readFileSync(file, 'utf8'));
    
    // 更新版本号
    tree.version = NEW_VERSION;
    
    // 写回文件
    fs.writeFileSync(file, JSON.stringify(tree, null, 2));
    
    console.log(`Updated: ${file}`);
  });
});
```

**运行：**
```bash
node scripts/update-version.js
```

#### 方法2：手动更新

```bash
# 1. 全局搜索替换
# VS Code: Ctrl+Shift+H
# 查找：   "version": "1.8.0"
# 替换为： "version": "1.8.5"

# 2. 仔细检查每个文件，避免误改其他字段
```

### 3. 发布新版本流程

```bash
# 1. 确保代码已提交
git status

# 2. 更新版本号
npm version minor  # 或 patch、major

# 3. 手动同步 VERSION 常量
# 编辑 src/misc/b3type.ts

# 4. 提交版本更新
git add src/misc/b3type.ts
git commit --amend --no-edit

# 5. 构建应用
npm run build

# 6. 打包发布
npm run dist

# 7. 推送到远程
git push origin master --tags
```

---

## 📊 版本号的设计原则

### 1. 向前兼容（必须）

**原则：**
- 新编辑器必须能打开旧文件
- 添加新字段时提供默认值
- 不删除或重命名已有字段

**示例：**
```typescript
// 1.8.0 添加 import 字段
interface TreeData {
  // ... 原有字段
  import: string[];  // 新字段
}

// 读取 1.7.0 文件时
const tree = readTree(path);
tree.import = tree.import || [];  // 提供默认值
```

### 2. 向后警告（建议）

**原则：**
- 旧编辑器打开新文件时警告
- 避免数据丢失或功能异常
- 提示用户升级

**实现：**
```typescript
if (isNewVersion(tree.version)) {
  warning("请升级编辑器");
}
```

### 3. 版本号语义化（规范）

**规范：**
- **主版本（major）**：不兼容的 API 改动
- **次版本（minor）**：向前兼容的功能性新增
- **补丁版本（patch）**：向前兼容的问题修正

**本项目示例：**
```
1.0.0 → 1.5.0  添加变量功能（minor）
1.5.0 → 1.5.1  修复变量 bug（patch）
1.5.1 → 1.8.0  添加子树功能（minor）
1.8.0 → 1.8.5  优化和 bug 修复（patch）
1.8.5 → 2.0.0  重写核心架构（major）
```

---

## 💡 最佳实践

### 1. 开发时

**规则：**
- ✅ 保持 `package.json` 和 `VERSION` 常量一致
- ✅ 开发期间使用同一版本号
- ✅ 提交代码前检查版本号
- ✅ 重大更新时更新主版本号

**检查命令：**
```bash
# 查看当前版本
npm version

# 或直接查看文件
cat package.json | grep version
```

### 2. 团队协作时

**规则：**
- ✅ 统一使用相同版本的编辑器
- ✅ 升级时团队同步更新
- ✅ 在文档中说明当前使用的版本
- ✅ 定期检查是否有新版本

**建议配置（README.md）：**
```markdown
## 开发环境

- Behavior3 Editor: v1.8.5
- Node.js: v18+
- npm: v9+

请确保使用相同版本的编辑器，避免兼容性问题。
```

### 3. 文件管理时

**规则：**
- ✅ 不要手动修改文件的 version 字段
- ✅ 让编辑器自动管理版本
- ✅ Git 提交时包含版本信息

**Git 提交示例：**
```bash
git commit -m "feat: 添加英雄AI行为树 (v1.8.5)"
```

---

## 🔍 常见问题

### Q1: 为什么有两个版本号（package.json 和 VERSION 常量）？

**A**: 职责不同：

```
package.json:
  - npm 包管理的版本
  - 应用安装包的版本
  - 自动更新检查

VERSION 常量:
  - 运行时代码使用
  - 文件版本比对
  - 创建文件时的版本标记
```

**必须保持一致！**

### Q2: 打开旧版本文件会有问题吗？

**A**: 不会，因为：
- 新编辑器向前兼容
- 旧文件缺少的字段会使用默认值
- 数据不会丢失

**示例：**
```
1.8.5 编辑器打开 1.7.0 文件
  ↓
缺少 import 字段
  ↓
自动补充 import = []
  ↓
正常编辑和保存
```

### Q3: 文件版本会自动更新吗？

**A**: 不会！

```
用 1.7.0 创建的文件：version: "1.7.0"
  ↓
用 1.8.5 编辑器打开、编辑、保存
  ↓
文件仍然是：version: "1.7.0"  ← 不变
```

**原因：**
- 版本号标识文件的创建版本
- 不是当前编辑器版本
- 追踪文件历史

**如需更新：**
- 手动修改 JSON 文件
- 或使用批处理脚本

### Q4: 如何知道编辑器的版本？

**A**: 三种方法：

```
1. 查看标题栏
   Behavior3 Editor - v1.8.5

2. 帮助菜单 → 关于
   显示版本信息

3. 查看代码
   src/misc/b3type.ts:27
   package.json:3
```

### Q5: 升级编辑器会影响旧文件吗？

**A**: 不会！

```
升级 1.8.0 → 1.8.5
  ↓
旧文件仍然可以正常打开、编辑、保存
  ↓
文件版本号保持不变（除非手动修改）
  ↓
完全向前兼容
```

**但建议：**
- 升级后测试关键文件
- 检查是否有警告信息
- 必要时更新文件版本号

---

## 🎯 版本管理检查清单

### 开发时
- [ ] package.json 和 VERSION 常量保持一致
- [ ] 添加新功能时决定版本递增策略（major/minor/patch）
- [ ] 测试新版本与旧文件的兼容性
- [ ] 更新 CHANGELOG（如果有）

### 发布时
- [ ] 确定版本号（根据更新内容）
- [ ] 更新两处版本号（package.json 和 VERSION 常量）
- [ ] 测试文件兼容性
- [ ] 创建 Git tag
- [ ] 发布到 GitHub Release

### 团队协作时
- [ ] 文档中说明当前版本
- [ ] 团队成员使用相同版本
- [ ] 升级时通知所有成员
- [ ] 遇到版本警告时及时处理

---

## 📚 参考资料

### 语义化版本规范
- 官方网站：https://semver.org/lang/zh-CN/
- 核心原则：major.minor.patch
- 版本递增规则

### npm version 命令
```bash
npm version patch   # 1.8.5 → 1.8.6
npm version minor   # 1.8.5 → 1.9.0
npm version major   # 1.8.5 → 2.0.0
npm version <specific>  # 指定版本号
```

### Git 标签
```bash
# 查看所有标签
git tag

# 创建标签
git tag v1.8.5

# 推送标签
git push origin v1.8.5

# 推送所有标签
git push origin --tags
```

---

## 🔧 版本相关的文件详解

### 1. 编辑器版本定义

#### 1.1 package.json
**文件路径：** `package.json:3`

```json
{
  "name": "behavior3editor",
  "version": "1.8.5",  ← 应用版本
  "main": "dist-electron/main/index.js",
  "description": "行为树编辑器"
}
```

**作用：**
- npm 包管理的标准版本字段
- 用于构建和发布
- 安装包文件名（如 `behavior3editor_1.8.5.exe`）
- Electron 自动更新时的版本比对

**修改方式：**
```bash
# 使用 npm 命令自动更新
npm version patch  # 1.8.5 → 1.8.6
npm version minor  # 1.8.5 → 1.9.0
npm version major  # 1.8.5 → 2.0.0
```

#### 1.2 src/misc/b3type.ts
**文件路径：** `src/misc/b3type.ts:27`

```typescript
/**
 * 编辑器版本号
 * 
 * 用途：
 * - 显示在标题栏和关于界面
 * - 检测行为树文件的兼容性
 * - 自动更新版本比对
 */
export const VERSION = "1.8.5";
```

**作用：**
- 运行时使用的版本常量
- 用于与文件版本比对
- 创建新文件时的版本标记
- 界面显示（标题栏、关于页面）

**修改方式：**
```typescript
// 手动修改，必须与 package.json 保持一致
export const VERSION = "1.8.6";
```

**注意：** 
- npm version 命令不会自动更新此文件
- 需要手动同步
- 建议使用脚本自动化

### 2. 文件版本（行为树 JSON 文件）

#### 2.1 主行为树文件

**示例：** `sample/workdir/hero.json:2`
```json
{
  "version": "1.8.0",  ← 此文件由 1.8.0 版本编辑器创建
  "name": "hero",
  "desc": "英雄测试AI",
  "export": true,
  "group": ["Client", "Server"],
  "root": { ... }
}
```

**示例：** `sample/workdir/monster.json:2`
```json
{
  "version": "1.8.0",
  "name": "monster",
  "desc": "怪物AI",
  ...
}
```

#### 2.2 子树文件

**示例：** `sample/workdir/sub/subtree1.json:2`
```json
{
  "version": "1.8.0",
  "name": "subtree1",
  "export": true,
  ...
}
```

#### 2.3 变量声明文件

**示例：** `sample/vars/declare-core.json:2`
```json
{
  "version": "1.8.0",
  "vars": [
    { "name": "hp", "desc": "生命值" },
    { "name": "mp", "desc": "魔法值" }
  ]
}
```

**所有示例文件的版本：**

| 文件路径 | 版本 | 类型 |
|---------|------|------|
| `sample/workdir/hero.json` | 1.8.0 | 主行为树 |
| `sample/workdir/monster.json` | 1.8.0 | 主行为树 |
| `sample/workdir/subtree1.json` | 1.8.0 | 子树 |
| `sample/workdir/subtree2.json` | 1.8.0 | 子树 |
| `sample/workdir/sub/subtree1.json` | 1.8.0 | 子树 |
| `sample/workdir/sub/subtree2.json` | 1.8.0 | 子树 |
| `sample/vars/declare-core.json` | 1.8.0 | 变量声明 |
| `sample/vars/declare-vars.json` | 1.8.0 | 变量声明 |
| `sample/vars/test-vars.json` | 1.8.0 | 变量声明 |
| `sample/vars/test-subtree.json` | 1.8.0 | 变量声明 |

**注意：**
- 所有示例文件版本为 1.8.0
- 当前编辑器版本为 1.8.5
- 打开这些文件不会警告（向前兼容）

### 3. 配置文件（无版本）

以下文件**没有**版本字段：

#### 3.1 工作区配置
**文件路径：** `sample/workspace.b3-workspace`

```json
{
  "files": [ ... ],
  "settings": { ... }
}
```

**原因：**
- 工作区配置格式很少变化
- 直接读取，不需要版本检查

#### 3.2 节点定义配置
**文件路径：** `sample/node-config.b3-setting`

```json
{
  "name": "Wait",
  "type": "Action",
  "desc": "等待指定时间",
  ...
}
```

**原因：**
- 节点定义由代码生成
- 每次加载时重新生成
- 不需要版本管理

### 4. 版本相关的代码文件

#### 4.1 版本比较逻辑

**文件路径：** `src/misc/b3util.ts:134-142`

```typescript
export const isNewVersion = (version: string) => {
  // 解析文件版本号：如 "1.8.5" → [1, 8, 5]
  const [major, minor, patch] = version.split(".").map(Number);
  
  // 解析编辑器版本号
  const [major2, minor2, patch2] = VERSION.split(".").map(Number);
  
  // 语义化版本比较
  return (
    major > major2 ||                                      // 主版本更大
    (major === major2 && minor > minor2) ||                // 次版本更大
    (major === major2 && minor === minor2 && patch > patch2) // 补丁版本更大
  );
};
```

**导入：**
```typescript
import { VERSION } from "./b3type";
```

#### 4.2 版本检查调用

**文件路径：** `src/contexts/workspace-context.ts:902-924`

```typescript
open: (path, focusId) => {
  path = Path.posixPath(path);
  const workspace = get();
  
  let editor = workspace.editors.find((v) => v.path === path);
  
  if (!editor) {
    try {
      // 创建编辑器，读取文件
      editor = new EditorStore(path);
      workspace.editors.push(editor);
      set({ editors: workspace.editors });
      workspace.updateFileMeta(editor);
      workspace.edit(editor.path, focusId);

      // ========== 版本检查 ==========
      if (b3util.isNewVersion(editor.data.version)) {
        message.warning(
          i18n.t("alertNewVersion", { version: editor.data.version })
        );
      }
      // =============================
    } catch (error) {
      console.error(error);
      message.error(`invalid file: ${path}`);
    }
  }
}
```

#### 4.3 创建文件时设置版本

**文件路径：** `src/misc/b3util.ts:918-930`

```typescript
export const createNewTree = (path: string) => {
  const tree: TreeData = {
    version: VERSION,  // ← 使用当前编辑器版本
    name: Path.basenameWithoutExt(path),
    prefix: "",
    group: [],
    import: [],
    vars: [],
    root: {
      id: "1",
      name: "Sequence",
      desc: "",
      children: [],
    },
  };
  return tree;
};
```

#### 4.4 国际化文本

**文件路径：** `public/locales/zh.json:5`
```json
{
  "alertNewVersion": "此文件由新版本 Behavior3({{version}}) 创建，请升级到最新版本。"
}
```

**文件路径：** `public/locales/en.json:5`
```json
{
  "alertNewVersion": "This file is created by a newer version of Behavior3({{version}}), please upgrade to the latest version."
}
```

### 5. 完整的版本相关文件清单

```
📁 版本定义
  ├─ package.json:3                          应用版本 (1.8.5)
  └─ src/misc/b3type.ts:27                   VERSION 常量 (1.8.5)

📁 版本使用（代码）
  ├─ src/misc/b3util.ts:134                  isNewVersion() 版本比较函数
  ├─ src/misc/b3util.ts:920                  createNewTree() 设置新文件版本
  └─ src/contexts/workspace-context.ts:914   open() 打开文件时检查

📁 国际化文本
  ├─ public/locales/zh.json:5                中文警告
  └─ public/locales/en.json:5                英文警告

📁 示例文件版本（全部 1.8.0）
  ├─ sample/workdir/hero.json:2              主行为树
  ├─ sample/workdir/monster.json:2           主行为树
  ├─ sample/workdir/subtree1.json:2          子树
  ├─ sample/workdir/subtree2.json:2          子树
  ├─ sample/workdir/sub/subtree1.json:2      子树
  ├─ sample/workdir/sub/subtree2.json:2      子树
  ├─ sample/vars/declare-core.json:2         变量声明
  ├─ sample/vars/declare-vars.json:2         变量声明
  ├─ sample/vars/test-vars.json:2            变量声明
  └─ sample/vars/test-subtree.json:2         变量声明

📁 无版本文件
  ├─ sample/workspace.b3-workspace           工作区配置
  └─ sample/node-config.b3-setting           节点定义
```

### 6. 版本字段在数据结构中的位置

#### 6.1 TypeScript 接口定义

**文件路径：** `src/misc/b3type.ts:672-683`

```typescript
export interface TreeData {
  /**
   * 行为树格式版本号
   * 
   * 用途：
   * - 兼容性检查
   * - 格式升级迁移
   * - 编辑器版本验证
   * 
   * 通常与编辑器版本一致：VERSION 常量
   */
  version: string;  ← 版本字段定义
  
  name: string;
  prefix: string;
  // ... 其他字段
}
```

#### 6.2 EditorStore 中的版本

**文件路径：** `src/contexts/workspace-context.ts:91-151`

```typescript
export class EditorStore {
  path: string;
  data: TreeData;  ← 包含 version 字段
  changed: boolean;
  mtime: number;
  
  constructor(path: string) {
    this.path = path;
    this.data = readTree(path);  ← 读取 JSON，包括 version
    this.data.name = Path.basenameWithoutExt(path);
    this.mtime = fs.statSync(path).mtimeMs;
    // ...
  }
}
```

---

## 📊 版本相关文件的数据流

### 1. 创建新文件时

```
用户：新建文件 → test.json
  ↓
Explorer.tsx
  dispatch("newFile")
  ↓
创建临时节点 path = "/.json"
  ↓
用户输入文件名 "test"
  ↓
submitRename()
  ├─ 生成 TreeData
  │  └─ createNewTree("test.json")
  │     ├─ 读取 VERSION 常量 (1.8.5)
  │     └─ 创建 { version: "1.8.5", name: "test", ... }
  ├─ JSON.stringify(treeData)
  └─ fs.writeFileSync("test.json", json)
  ↓
test.json 文件创建，包含 version: "1.8.5"
```

**涉及文件：**
- `src/misc/b3type.ts` - VERSION 常量来源
- `src/misc/b3util.ts` - createNewTree() 函数
- `src/components/explorer.tsx` - 新建文件逻辑

### 2. 打开文件时

```
用户：点击文件树中的 hero.json
  ↓
Explorer.tsx
  onSelect → dispatch("open")
  ↓
workspace.open("hero.json")
  ↓
new EditorStore("hero.json")
  ├─ readTree("hero.json")
  │  ├─ fs.readFileSync("hero.json")
  │  ├─ JSON.parse(content)
  │  └─ TreeData { version: "1.8.0", ... }
  └─ this.data = treeData
  ↓
版本检查
  isNewVersion("1.8.0")
  ├─ 文件版本：1.8.0
  ├─ 编辑器版本：1.8.5
  └─ 1.8.0 < 1.8.5 → false（无需警告）
  ↓
正常打开文件
```

**涉及文件：**
- `src/contexts/workspace-context.ts` - open() 方法，版本检查
- `src/misc/b3util.ts` - isNewVersion() 函数
- `src/misc/util.ts` - readTree() 函数
- `public/locales/*.json` - 警告文本

### 3. 保存文件时

```
用户：按 Ctrl+S 保存
  ↓
workspace.save()
  ↓
editor.dispatch("save")
  ↓
graph.save()
  ├─ 收集所有 NodeData
  ├─ 构建 TreeData {
  │    version: "1.8.0",  ← 保留原有版本（不修改）
  │    name: "hero",
  │    root: { ... }
  │  }
  └─ writeTree(path, treeData)
     ├─ JSON.stringify(treeData, null, 2)
     └─ fs.writeFileSync(path, json)
  ↓
文件保存，版本号保持不变
```

**涉及文件：**
- `src/components/graph.ts` - save() 方法
- `src/misc/util.ts` - writeTree() 函数

### 4. 版本警告显示时

```
打开 hero.json (假设 version: "1.9.0")
  ↓
workspace.open("hero.json")
  ↓
创建 EditorStore
  └─ this.data.version = "1.9.0"
  ↓
版本检查
  isNewVersion("1.9.0")
  ├─ 文件版本：1.9.0
  ├─ 编辑器版本：1.8.5
  └─ 1.9.0 > 1.8.5 → true ✓
  ↓
显示警告
  message.warning(
    i18n.t("alertNewVersion", { version: "1.9.0" })
  )
  ↓
界面弹出提示：
  "此文件由新版本 Behavior3(1.9.0) 创建，请升级到最新版本。"
  ↓
文件仍然打开（允许编辑，但可能有兼容性问题）
```

**涉及文件：**
- `src/contexts/workspace-context.ts` - 版本检查逻辑
- `src/misc/b3util.ts` - isNewVersion() 函数
- `src/misc/i18n.ts` - 国际化系统
- `public/locales/zh.json` - 警告文本
- `src/misc/hooks.ts` - message 组件（AntD）

---

## 🔍 代码位置索引

### 定义位置
```typescript
// 编辑器版本
package.json:3                     "version": "1.8.5"
src/misc/b3type.ts:27              export const VERSION = "1.8.5"

// 文件版本（接口定义）
src/misc/b3type.ts:672-683         interface TreeData { version: string; ... }
```

### 使用位置
```typescript
// 版本比较
src/misc/b3util.ts:134-142         isNewVersion(version: string): boolean

// 创建文件
src/misc/b3util.ts:918-930         createNewTree() 设置 version: VERSION

// 打开文件检查
src/contexts/workspace-context.ts:914-916  
  if (b3util.isNewVersion(editor.data.version)) { ... }

// 读取文件
src/misc/util.ts                   readTree(path): TreeData
  └→ 解析 JSON，包含 version 字段

// 保存文件
src/misc/util.ts                   writeTree(path, tree)
  └→ 序列化 TreeData，包含 version 字段
```

### 国际化文本
```typescript
public/locales/zh.json:5           "alertNewVersion": "..."
public/locales/en.json:5           "alertNewVersion": "..."
src/misc/i18n.ts                   国际化初始化
```

### 界面显示（计划中）
```typescript
// 标题栏可能显示版本（当前未实现）
src/components/titlebar.tsx       可添加版本显示

// 关于对话框显示版本（当前未实现）
// 可在菜单中添加 "关于" → 显示 VERSION
```

---

## 🛠️ 版本管理工具

### 1. 自动化脚本（建议添加）

#### 1.1 版本同步脚本

**创建文件：** `scripts/sync-version.js`

```javascript
/**
 * 自动同步 package.json 和 VERSION 常量
 */
const fs = require('fs');
const path = require('path');

// 读取 package.json
const pkg = require('../package.json');
const version = pkg.version;

// 更新 b3type.ts
const b3typePath = path.join(__dirname, '../src/misc/b3type.ts');
let content = fs.readFileSync(b3typePath, 'utf8');

// 替换 VERSION 常量
content = content.replace(
  /export const VERSION = "[^"]+"/,
  `export const VERSION = "${version}"`
);

fs.writeFileSync(b3typePath, content);

console.log(`Version synced to: ${version}`);
```

**使用：**
```bash
# 1. 更新 package.json 版本
npm version patch

# 2. 自动同步到 VERSION 常量
node scripts/sync-version.js
```

#### 1.2 文件版本统一脚本

**创建文件：** `scripts/update-file-versions.js`

```javascript
/**
 * 批量更新所有行为树文件的版本号
 */
const fs = require('fs');
const glob = require('glob');

const NEW_VERSION = process.argv[2] || "1.8.5";

glob("sample/**/*.json", (err, files) => {
  if (err) {
    console.error(err);
    return;
  }
  
  files.forEach(file => {
    try {
      const content = fs.readFileSync(file, 'utf8');
      const tree = JSON.parse(content);
      
      // 只更新行为树文件（有 root 字段）
      if (tree.root) {
        tree.version = NEW_VERSION;
        fs.writeFileSync(file, JSON.stringify(tree, null, 2));
        console.log(`Updated: ${file} -> ${NEW_VERSION}`);
      }
    } catch (error) {
      console.error(`Error processing ${file}:`, error.message);
    }
  });
});
```

**使用：**
```bash
# 更新所有文件到 1.8.5
node scripts/update-file-versions.js 1.8.5
```

### 2. package.json 添加脚本

```json
{
  "scripts": {
    "version:sync": "node scripts/sync-version.js",
    "version:update-files": "node scripts/update-file-versions.js"
  }
}
```

**使用：**
```bash
# 发布新版本的完整流程
npm version patch        # 更新 package.json
npm run version:sync     # 同步到 VERSION 常量
npm run build            # 构建
npm run dist             # 打包
```

---

## 🎉 总结

### 版本系统的核心作用

1. **标识和追踪**
   - 标识编辑器版本
   - 标识文件创建版本
   - 追踪格式演进历史

2. **兼容性保障**
   - 向前兼容：新编辑器读旧文件
   - 向后警告：旧编辑器读新文件时提示
   - 避免数据损坏

3. **团队协作**
   - 确保版本一致性
   - 及时发现版本问题
   - 协调升级时机

4. **格式演进**
   - 支持数据格式升级
   - 记录功能变化
   - 提供迁移路径

### 记住

**版本号不是装饰，而是：**
- ✅ 数据完整性的保障
- ✅ 团队协作的基础
- ✅ 格式演进的记录

**最佳实践：**
- 保持两处版本号一致
- 团队使用相同版本
- 遇到版本警告及时处理
- 升级时做好测试和备份

