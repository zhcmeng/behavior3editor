# Behavior3Editor 打包流程详解

## 📋 目录

1. [打包工具链](#打包工具链)
2. [构建流程](#构建流程)
3. [详细步骤解析](#详细步骤解析)
4. [配置文件详解](#配置文件详解)
5. [输出文件说明](#输出文件说明)
6. [平台特定配置](#平台特定配置)
7. [常见问题](#常见问题)

---

## 🛠️ 打包工具链

这个项目使用了现代化的 Electron 打包方案：

```
┌─────────────────────────────────────────────────────────┐
│                    打包工具链                            │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  TypeScript (tsc)                                       │
│  └─> 类型检查                                           │
│                                                         │
│  Vite                                                   │
│  ├─> 编译主进程 (electron/main/index.ts)               │
│  ├─> 编译预加载脚本 (electron/preload/index.ts)        │
│  └─> 编译渲染进程 (src/**/*.tsx)                       │
│                                                         │
│  electron-builder                                       │
│  └─> 打包成可执行文件 (.exe, .dmg, .zip)               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 核心工具

| 工具 | 版本 | 作用 |
|-----|------|------|
| **TypeScript** | 5.8.2 | 类型检查和编译 |
| **Vite** | 6.3.5 | 现代化构建工具 |
| **vite-plugin-electron** | 0.29.0 | Vite 的 Electron 插件 |
| **electron-builder** | 24.13.3 | Electron 应用打包工具 |
| **React** | 18.3.1 | UI 框架 |
| **Electron** | 33.2.0 | 桌面应用框架 |

---

## 🔄 构建流程

### 一键构建命令

```bash
npm run build
```

### 完整流程图

```
┌────────────────────────────────────────────────────────────┐
│                      npm run build                          │
└──────────────────────┬─────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ↓              ↓              ↓
    ┌───────┐    ┌──────────┐   ┌─────────────────┐
    │  tsc  │    │   vite   │   │ electron-builder│
    │       │    │  build   │   │                 │
    └───┬───┘    └────┬─────┘   └────────┬────────┘
        │             │                  │
        ↓             ↓                  ↓
   类型检查      编译代码           打包可执行文件
   (不生成代码)  ├─ 主进程           ├─ Windows: .exe
                 ├─ 预加载           ├─ macOS: .dmg, .zip
                 └─ 渲染进程         └─ Linux: .AppImage
        │             │                  │
        └─────────────┴──────────────────┘
                       │
                       ↓
             release/1.8.5/ 目录
             ├─ behavior3editor_1.8.5.exe (Windows)
             ├─ behavior3editor_1.8.5.dmg (macOS)
             └─ behavior3editor_1.8.5.zip (macOS)
```

---

## 📝 详细步骤解析

### 步骤 1：TypeScript 类型检查

```bash
tsc
```

**作用**：
- 检查 TypeScript 类型错误
- **不生成**任何 JavaScript 文件（`--noEmit` 配置在 `tsconfig.json` 中）
- 确保代码类型安全

**配置文件**：`tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "jsx": "react-jsx",
    "strict": true,
    // ... 其他配置
  }
}
```

**为什么需要？**
- 捕获类型错误
- 提高代码质量
- IDE 智能提示支持

---

### 步骤 2：Vite 构建

```bash
vite build
```

这一步会编译三个部分：

#### 2.1 主进程（Main Process）

**入口文件**：`electron/main/index.ts`

**输出目录**：`dist-electron/main/`

```
electron/main/index.ts
      ↓ [Vite + TypeScript]
dist-electron/main/index.js
```

**构建配置**（`vite.config.ts`）：

```javascript
main: {
  entry: "electron/main/index.ts",
  vite: {
    build: {
      sourcemap: true,              // 生成 source map
      target: ["chrome89", ...],    // 目标浏览器版本
      minify: false,                // 不压缩（开发模式）
      outDir: "dist-electron/main", // 输出目录
      rollupOptions: {
        external: Object.keys(pkg.dependencies), // 外部依赖
      },
    },
  },
}
```

**关键点**：
- 不打包 `dependencies` 中的包（保持为 `require()` 调用）
- 生成 source map 便于调试
- 不压缩代码（可配置）

#### 2.2 预加载脚本（Preload Script）

**入口文件**：`electron/preload/index.ts`

**输出目录**：`dist-electron/preload/`

```
electron/preload/index.ts
      ↓ [Vite + TypeScript]
dist-electron/preload/index.mjs
```

**构建配置**：

```javascript
preload: {
  input: "electron/preload/index.ts",
  vite: {
    build: {
      sourcemap: "inline",            // 内联 source map
      minify: false,
      outDir: "dist-electron/preload",
      rollupOptions: {
        external: Object.keys(pkg.dependencies),
      },
    },
  },
}
```

**关键点**：
- 使用内联 source map
- 输出为 ES Module (`.mjs`)

#### 2.3 渲染进程（Renderer Process）

**入口文件**：`index.html` → `src/main.tsx`

**输出目录**：`dist/`

```
index.html
  ↓
src/main.tsx
  ↓
src/components/**/*.tsx
  ↓ [Vite + React + TypeScript]
dist/
├── index.html
└── assets/
    ├── index-[hash].js
    ├── index-[hash].css
    └── ...
```

**构建配置**（Vite 默认配置）：

```javascript
build: {
  sourcemap: true,
  // 默认构建为生产模式的 React 应用
}
```

**关键点**：
- 打包所有 React 组件
- 代码分割和优化
- CSS 提取和压缩
- 资源文件处理（图标、字体等）

---

### 步骤 3：electron-builder 打包

```bash
electron-builder
```

**作用**：
- 将编译好的代码打包成可执行文件
- 生成安装包
- 代码签名（可选）
- 自动更新支持（可选）

**配置文件**：`electron-builder.json`

```json
{
  "appId": "behavior3editor",
  "productName": "Behavior3 Editor",
  "asar": true,
  "directories": {
    "output": "release/${version}"
  },
  "files": ["dist-electron", "dist"],
  // ... 平台特定配置
}
```

**工作流程**：

```
┌─────────────────────────────────────────┐
│    electron-builder 打包流程             │
├─────────────────────────────────────────┤
│                                         │
│ 1. 读取 package.json                    │
│    ├─ name: behavior3editor            │
│    ├─ version: 1.8.5                   │
│    └─ main: dist-electron/main/index.js│
│                                         │
│ 2. 复制文件到临时目录                   │
│    ├─ dist-electron/ (Electron 代码)   │
│    └─ dist/ (React 应用)               │
│                                         │
│ 3. 安装生产依赖                         │
│    └─ npm install --production         │
│                                         │
│ 4. 打包成 ASAR 归档                     │
│    └─ app.asar (压缩的应用代码)         │
│                                         │
│ 5. 嵌入 Electron 运行时                │
│    ├─ electron.exe (Windows)           │
│    └─ Electron.app (macOS)             │
│                                         │
│ 6. 生成安装包                           │
│    ├─ NSIS 安装器 (Windows)            │
│    ├─ DMG 镜像 (macOS)                 │
│    └─ ZIP 压缩包 (便携版)              │
│                                         │
│ 7. 输出到 release/ 目录                │
│                                         │
└─────────────────────────────────────────┘
```

---

## ⚙️ 配置文件详解

### 1. `package.json`

```json
{
  "name": "behavior3editor",
  "version": "1.8.5",                    // 版本号（自动更新检测用）
  "main": "dist-electron/main/index.js", // 主进程入口
  "type": "module",                      // 使用 ES Module
  
  "scripts": {
    "dev": "vite",                       // 开发模式
    "build": "tsc && vite build && electron-builder", // 构建
    "preview": "vite preview",           // 预览构建结果
  },
  
  "dependencies": {
    // 生产环境依赖（会被打包到应用中）
    "@ant-design/icons": "^5.4.0",
    "antd": "^5.20.0",
    "react": "^18.3.1",
    // ...
  },
  
  "devDependencies": {
    // 开发依赖（不会被打包）
    "electron": "^33.2.0",
    "electron-builder": "^24.13.3",
    "vite": "^6.3.5",
    // ...
  }
}
```

**关键字段**：
- `main`: Electron 启动时加载的文件
- `type`: 使用 ES Module 语法
- `version`: 应用版本号

---

### 2. `electron-builder.json`

```json
{
  "$schema": "https://raw.githubusercontent.com/electron-userland/electron-builder/master/packages/app-builder-lib/scheme.json",
  
  // 基础配置
  "appId": "behavior3editor",              // 应用唯一标识
  "productName": "Behavior3 Editor",       // 应用显示名称
  "asar": true,                            // 使用 ASAR 归档（压缩代码）
  
  // 输出目录
  "directories": {
    "output": "release/${version}"         // 输出到 release/1.8.5/
  },
  
  // 要打包的文件
  "files": [
    "dist-electron",                       // Electron 代码
    "dist"                                 // React 应用
  ],
  
  // macOS 配置
  "mac": {
    "artifactName": "behavior3editor_${version}.${ext}",
    "target": ["dmg", "zip"]               // 生成 DMG 和 ZIP
  },
  
  // Windows 配置
  "win": {
    "target": [
      {
        "target": "nsis",                  // NSIS 安装器
        "arch": ["x64"]                    // 64 位
      }
    ],
    "artifactName": "behavior3editor_${version}.${ext}"
  },
  
  // NSIS 安装器配置（Windows）
  "nsis": {
    "oneClick": false,                     // 非一键安装（显示安装界面）
    "perMachine": false,                   // 为当前用户安装（非系统级）
    "allowToChangeInstallationDirectory": true, // 允许选择安装目录
    "deleteAppDataOnUninstall": false      // 卸载时保留用户数据
  },
  
  // 自动更新配置（可选）
  "publish": {
    "provider": "generic",
    "channel": "latest",
    "url": "https://github.com/electron-vite/electron-vite-react/releases/download/v0.9.9/"
  }
}
```

---

### 3. `vite.config.ts`

```typescript
export default defineConfig(({ command }) => {
  // 清理旧的构建文件
  rmSync("dist-electron", { recursive: true, force: true });

  return {
    // 路径别名
    resolve: {
      alias: {
        "@": path.join(__dirname, "src"),   // @/components -> src/components
      },
    },
    
    // 构建配置
    build: {
      sourcemap: true,                       // 生成 source map
    },
    
    // 插件
    plugins: [
      react(),                               // React 支持
      electron({
        main: { /* 主进程配置 */ },
        preload: { /* 预加载脚本配置 */ },
        renderer: {},
      }),
    ],
    
    // 开发服务器配置
    server: {
      host: "127.0.0.1",
      port: 7777,
    },
  };
});
```

---

## 📦 输出文件说明

### 构建产物目录结构

```
项目根目录/
├── dist-electron/           # Electron 进程代码（编译后）
│   ├── main/
│   │   ├── index.js        # 主进程
│   │   └── index.js.map    # Source map
│   └── preload/
│       ├── index.mjs       # 预加载脚本
│       └── index.mjs.map   # Source map
│
├── dist/                    # React 应用（编译后）
│   ├── index.html          # HTML 入口
│   └── assets/
│       ├── index-[hash].js # React 应用代码
│       ├── index-[hash].css# 样式文件
│       └── ...             # 其他资源
│
└── release/                 # 最终打包文件
    └── 1.8.5/
        ├── behavior3editor_1.8.5.exe        (Windows 安装器)
        ├── behavior3editor_1.8.5.exe.blockmap
        ├── behavior3editor_1.8.5.dmg        (macOS 镜像)
        ├── behavior3editor_1.8.5.dmg.blockmap
        ├── behavior3editor_1.8.5.zip        (macOS 压缩包)
        ├── latest.yml                        (自动更新配置)
        └── latest-mac.yml
```

### 文件说明

#### `dist-electron/`

编译后的 Electron 代码，包含：
- **主进程**：Node.js 环境，管理窗口和生命周期
- **预加载脚本**：在渲染进程创建前执行

#### `dist/`

编译后的 React 应用，包含：
- HTML、CSS、JavaScript
- 图标、字体等静态资源
- 已优化和压缩

#### `release/1.8.5/`

最终的可执行文件：

| 文件 | 平台 | 类型 | 说明 |
|-----|------|------|------|
| `*.exe` | Windows | 安装器 | NSIS 安装程序 |
| `*.dmg` | macOS | 镜像 | 磁盘镜像文件 |
| `*.zip` | macOS | 压缩包 | 便携版 |
| `*.blockmap` | 所有 | 差异文件 | 自动更新用 |
| `latest*.yml` | 所有 | 配置 | 自动更新配置 |

---

## 🖥️ 平台特定配置

### Windows

```json
"win": {
  "target": [{
    "target": "nsis",              // 使用 NSIS 安装器
    "arch": ["x64"]                // 64 位架构
  }],
  "artifactName": "behavior3editor_${version}.${ext}"
}
```

**NSIS 配置**：
```json
"nsis": {
  "oneClick": false,               // 显示安装界面（非一键安装）
  "perMachine": false,             // 用户级安装（无需管理员权限）
  "allowToChangeInstallationDirectory": true, // 可选择安装位置
  "deleteAppDataOnUninstall": false // 保留用户数据
}
```

**输出文件**：
- `behavior3editor_1.8.5.exe` - NSIS 安装器（约 100-200 MB）
- 安装后位置：`%LOCALAPPDATA%\Programs\Behavior3 Editor\`

---

### macOS

```json
"mac": {
  "artifactName": "behavior3editor_${version}.${ext}",
  "target": ["dmg", "zip"]         // 生成 DMG 和 ZIP 两种格式
}
```

**输出文件**：
- `behavior3editor_1.8.5.dmg` - 磁盘镜像文件
  - 用户可以拖拽到 Applications 文件夹安装
- `behavior3editor_1.8.5.zip` - 便携版压缩包
  - 解压即用，无需安装

**代码签名**（可选）：
```json
"mac": {
  "identity": "Developer ID Application: Your Name (TEAMID)",
  "hardenedRuntime": true,
  "gatekeeperAssess": false
}
```

---

### Linux（未配置）

如需 Linux 支持，可添加：

```json
"linux": {
  "target": ["AppImage", "deb", "rpm"],
  "category": "Development"
}
```

---

## 🔧 常见问题

### 1. 为什么构建这么慢？

**原因**：
- TypeScript 类型检查
- Vite 编译三个部分
- electron-builder 打包和压缩
- 安装生产依赖

**优化**：
```json
// vite.config.ts
{
  "minify": false,        // 开发时不压缩
  "sourcemap": false,     // 不需要时禁用 source map
}
```

---

### 2. ASAR 是什么？

**ASAR**（Atom Shell Archive）是一种归档格式：

```
app.asar
├── dist-electron/
├── dist/
├── node_modules/
└── package.json
```

**优点**：
- ✅ 压缩文件大小（减少 30-50%）
- ✅ 加快启动速度（单文件读取）
- ✅ 简单的代码保护（不是加密）

**缺点**：
- ⚠️ 无法修改文件（只读）
- ⚠️ 某些 Node.js API 可能不兼容

**禁用 ASAR**（如果需要）：
```json
{
  "asar": false
}
```

---

### 3. 为什么要外部化依赖？

```javascript
rollupOptions: {
  external: Object.keys(pkg.dependencies)
}
```

**原因**：
- 依赖包含 native 模块（如 `sqlite3`、`node-pty`）
- 保持为 `require()` 调用，而不是打包进代码
- electron-builder 会在打包时重新安装和编译

---

### 4. 如何减小安装包体积？

**方法**：
1. **移除不必要的依赖**
   ```bash
   npm uninstall unused-package
   ```

2. **使用 `devDependencies`**
   ```json
   // 开发工具放在 devDependencies
   "devDependencies": {
     "typescript": "^5.8.2",
     "vite": "^6.3.5"
   }
   ```

3. **禁用 source map**（生产环境）
   ```javascript
   build: {
     sourcemap: false
   }
   ```

4. **启用代码压缩**
   ```javascript
   build: {
     minify: "terser"
   }
   ```

---

### 5. 如何配置自动更新？

**步骤 1**：配置发布地址

```json
"publish": {
  "provider": "github",
  "owner": "your-username",
  "repo": "behavior3editor"
}
```

**步骤 2**：在代码中启用

```typescript
// electron/main/update.ts
import { autoUpdater } from "electron-updater";

autoUpdater.checkForUpdatesAndNotify();
```

**步骤 3**：发布到 GitHub Releases

```bash
npm run build
# 上传 release/ 目录中的文件到 GitHub Releases
```

---

### 6. 如何调试打包问题？

**方法 1**：查看详细日志
```bash
DEBUG=electron-builder npm run build
```

**方法 2**：检查打包内容
```bash
# 解压 ASAR 文件查看内容
npx asar extract app.asar ./extracted
```

**方法 3**：禁用 ASAR 调试
```json
{
  "asar": false
}
```

---

## 📊 完整构建时间分析

典型的构建时间分布：

```
┌─────────────────────────────────────────┐
│         构建时间分析（参考）             │
├─────────────────────────────────────────┤
│                                         │
│  TypeScript 类型检查      ~10-30 秒     │
│  ████████                               │
│                                         │
│  Vite 编译                ~20-60 秒     │
│  ████████████████                       │
│  ├─ 主进程               ~5-10 秒      │
│  ├─ 预加载脚本            ~3-5 秒       │
│  └─ 渲染进程             ~10-40 秒      │
│                                         │
│  electron-builder 打包    ~30-90 秒     │
│  ████████████████████████               │
│  ├─ 安装依赖             ~15-30 秒      │
│  ├─ 打包 ASAR            ~5-10 秒       │
│  └─ 生成安装器            ~10-50 秒      │
│                                         │
│  总计                     ~60-180 秒     │
│                                         │
└─────────────────────────────────────────┘
```

---

## 🚀 快速参考

### 常用命令

```bash
# 开发模式（热更新）
npm run dev

# 类型检查
npm run tsc-check

# 构建（完整流程）
npm run build

# 只构建不打包（调试用）
npm run preview
```

### 构建目录

```
dist-electron/    # Electron 代码
dist/             # React 应用
release/          # 最终安装包
```

### 配置文件

```
package.json           # 项目配置
electron-builder.json  # 打包配置
vite.config.ts         # 构建配置
tsconfig.json          # TypeScript 配置
```

---

## 📚 相关资源

- [electron-builder 文档](https://www.electron.build/)
- [Vite 文档](https://vitejs.dev/)
- [vite-plugin-electron](https://github.com/electron-vite/vite-plugin-electron)
- [ASAR 格式说明](https://github.com/electron/asar)

现在你应该完全理解这个项目的打包流程了！🎉

